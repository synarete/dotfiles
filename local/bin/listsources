#!/usr/bin/env python3
'''
listsource -- Command-line utility to list C source/header files
'''
import os
import sys
import shlex
import subprocess


def subexec(cmd):
    '''Execute command as sub-process, raise exception upon failure'''
    pipes = subprocess.Popen(shlex.split(cmd),
                             stdout=subprocess.PIPE,
                             stderr=subprocess.PIPE,
                             shell=False,
                             env=os.environ.copy())
    std_out, _ = pipes.communicate()
    if pipes.returncode != 0:
        raise Exception('failed: ' + cmd)
    return std_out.decode('UTF-8')


def main():
    '''List C source (for Makefile.am format)'''
    subs = sys.argv[1:] or [os.path.realpath(os.getcwd())]
    names = []
    for sub in subs:
        cmd = "find {0} -type f -name '*.[ch]' ".format(sub)
        srcs = subexec(cmd)
        for src in srcs.split():
            base = os.path.realpath(sub)
            path = os.path.realpath(src)
            name = str(path).replace(base, '').lstrip('/')
            names.append(name)
    for name in sorted(set(names)):
        print(name + ' \\')


if __name__ == '__main__':
    try:
        main()
    except KeyboardInterrupt:
        pass
    sys.exit(0)
